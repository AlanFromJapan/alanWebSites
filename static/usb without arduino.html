<html>
  <head>
    <title>kalshagar - USB without Arduino</title>
    <link rel="stylesheet" href="static/style.css" type="text/css" />
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  </head>
  <body>
    <div class="wiki" id="content_view" style="display: block;">
<span style="background-color: #ffb500;
text-align: center;
display: block;
font-weight:bold;">Software: V-USB <a class="wiki_link_ext" href="http://www.obdev.at/products/vusb/index.html" rel="nofollow">http://www.obdev.at/products/vusb/index.html</a><br />
Hardware: <a class="wiki_link" href="RapideUSB.html">RapideUSB</a> </span><br />
<br />
Everything is said : just use that code for ATmel processors, and you can emulate USB stuffs. No need of an Arduino for lightweight projects anymore.<br />
However, there's a high cost to enter and tame V-USB. I believe it came at a hard cost of analysis for lots of people for I see few people giving clear samples of how to do stuffs. Worse are the examples of V-USB itself that are not for beginners <em>at all</em>: unclear, not really explained, you have no idea why it works or not. So let me try to bring my help here (and if you don't care, me neither, it will be my cookbook).<br />
<br />
<span style="
display: block; 
border:solid 2px black;
margin-left: 20px;
margin-right: 20px;
padding:20px;"><strong>Golden rule(s) of V-USB:</strong><br />
① There is scarce internet documentation but the latest versions doc is well commented so <strong>read it</strong>. I was often stucked for hours and the answer was explained nearly in plain text in the file <strong>usbconfig.h</strong> so just read it <u>carefully</u> !<br />
② Respect the hardware design, that will be so much trouble you can forget about. The one used here under (Zener diode) has the big advantage to let your MCU run at 5v and to cost nothing in parts. Go for it unless you work in 3.3v and in that case use the other option.</span><br />
<h1 id="toc0"><a name="Keyboard : Sending characters as a HID (no driver)"></a>Keyboard : Sending characters as a HID (no driver)</h1>
 <em>This is written at the occasion of creating the <a class="wiki_link" href="Finger%20Password%20Keyboard.html">Finger Password Keyboard</a>, which is my second USB project. I will use this occasion to improve my explanation.</em><br />
<h2 id="toc1"><a name="Keyboard : Sending characters as a HID (no driver)-Links"></a> Links </h2>
A big <strong>thank you</strong> to the following:<br />
<ul><li>A very good how-to-make-a-keyboard for dummies <a class="wiki_link_ext" href="http://codeandlife.com/2012/06/18/usb-hid-keyboard-with-v-usb/" rel="nofollow">http://codeandlife.com/2012/06/18/usb-hid-keyboard-with-v-usb/</a></li><li>A very good introduction to the HID descriptor by Franck Zao <a class="wiki_link_ext" href="http://eleccelerator.com/tutorial-about-usb-hid-report-descriptors/" rel="nofollow">http://eleccelerator.com/tutorial-about-usb-hid-report-descriptors/</a></li></ul><br />
My sample keyboard project <a class="wiki_link_ext" href="https://github.com/AlanFromJapan/alanarduinotools/tree/master/Atmegaxx8/UsbKeyboardSample" rel="nofollow" target="_blank">UsbKeyboardSample project on GitHub</a> <br />
Highlights:<br />
<ul><li>Sending key strokes: do send the character and then send right after the character 0 to signify that key is unpressed (see in the main loop)</li><li>idle: in vusb-config.h in usbFunctionSetup() the get/set of the keyboard idle rate. Just simply ignore it, implement the get/set only</li><li>Keyboard descriptor: just kept the one generated by the USB fundation generator, and use the struct from sample here above.</li></ul><br />
<h1 id="toc2"><a name="Keyboard : Receiving data from host as a HID (no driver)"></a>Keyboard : Receiving data from host as a HID (no driver)</h1>
 <img src="files/TricolorUsbSignal-basic.png" alt="TricolorUsbSignal-basic.png" title="TricolorUsbSignal-basic.png" /><br />
<em>Basic configuration : with that hardware, you will receive the host reports (project <a class="wiki_link" href="Tricolor%20USB%20alert.html">Tricolor USB alert</a>)</em><br />
<br />
<h2 id="toc3"><a name="Keyboard : Receiving data from host as a HID (no driver)-Option (1): be a Blink(1)"></a> Option (1): be a Blink(1) </h2>
<span style="font-variant: small-caps; display:block; background:#CCFF66;text-align:center;">This approach <u>works perfectly</u>, though it forbids to to send and receive characters (not a keyboard). A great &quot;thank you !&quot; to the guys at ThingM for their Blink(1) firmware and software code that I adapted to my needs.<br />
It's a good thing I tried by myself first, it helped me greatly to understand what I had to change/keep in the thingM.blink(1) firmware.</span><br />
The guys at <a class="wiki_link_ext" href="http://blink1.thingm.com/" rel="nofollow">ThingM made a Blink(1)</a>, a small gadget you plug to your PC and that shows notifications through RGB pulse, fade, blink... requires no driver (you bet, it's a proprietary HID), you install a small software that talks to the gadget on your PC and you're done. That's exactly what we need. <br />
<strong>All the source code firmware and software (host side) is here : <a class="wiki_link_ext" href="https://github.com/todbot/blink1" rel="nofollow">https://github.com/todbot/blink1</a></strong><br />
<br />
Source code is <a class="wiki_link_ext" href="https://code.google.com/p/alanarduinotools/source/browse/#svn%2Ftags%2FAttiny2313%2FVUSB_KeyboardReceiver_ThingMBlink1" rel="nofollow">on Google SVN</a>, it's tagged. It justs gets one byte message and display it on PORT B of Attiny2313. <br />
I change a bit their code to save space and adapt to my needs:<br />
<ul><li>Removed the serial number</li><li>Remove their app-specific logic</li></ul><br />
<h2 id="toc4"><a name="Keyboard : Receiving data from host as a HID (no driver)-Option (2): implement from scratch"></a> Option (2): implement from scratch </h2>
<span style="font-variant: small-caps; display:block; background:whitesmoke;text-align:center;">This approach works partially: you get a keyboard, you can receive the Num lock, Caps lock, etc,,, leds status but you can't have a program talk to you. I tried C# and Python, each time I got errors. So unless one day I (or you?) find and fix the issue, consider that this approach <u>doesn't work</u>.</span><br />
Use that tag <a class="wiki_link_ext" href="https://alanarduinotools.googlecode.com/svn/tags/Attiny2313/VUSB_KeyboardReceiver_TricolorUsbSignal" rel="nofollow">https://alanarduinotools.googlecode.com/svn/tags/Attiny2313/VUSB_KeyboardReceiver_TricolorUsbSignal</a><br />
You get a project that receives the changes of leds from your PC. It stopped sending characters (I must have mixed something) but in this project I didn't need it so I just removed everything that was linked to it. It's using an <a class="wiki_link" href="ATtiny2313.html">ATtiny2313</a> and there's very few space left (maybe 10%) so beware that if you want to do more than blinking leds you might want a slightly bigger MCU in terms of Flash available.<br />
To understand what is it you need, I added a comment <em>[Receive USB: you need this!]</em> everyhere there was a piece of code needed. But in a nutshell, you need the skeleton of the V-USB project plus:<br />
<ul><li>In main.c:<ul><li>Force the F_CPU at the top 12000000 (=12MHz)</li><li>In hardwareInit() init whatever pins you need (can skip)</li><li>In main(): nothing special, just do the usbPoll() to make your PC happy</li></ul></li><li>In usbconfig.h:<ul><li>Force <em>#define USB_CFG_CLOCK_KHZ       12000 </em></li><li>DO NOT change the &quot;Hardware Config&quot; part, or if you do read <u>carefully</u> the comments and change the other #define at the bottom of the file. You change this if you don't want to use D4 and D2.</li><li>Set <em>#define USB_CFG_IMPLEMENT_FN_WRITE      1</em> 'cause you want the &quot;Set Report&quot; callback to be called (usbFunctionWrite())</li><li>Make sure that this <em>#define USB_CFG_HID_REPORT_DESCRIPTOR_LENGTH    63</em> is the same size compared to your <em>usbHidReportDescriptor</em></li><li>About the vendorID : change it! RTFM.</li></ul></li><li>In vusb-config.h:<ul><li>The <em>usbHidReportDescriptor</em> was designed with the HID Descriptor tool <a class="wiki_link_ext" href="http://www.usb.org/developers/hidpage/" rel="nofollow">http://www.usb.org/developers/hidpage/</a></li><li><em>usbFunctionSetup()</em> covers the SET_REPORT and also the GET/SET_PROTOCOL</li><li><em>usbFunctionWrite()</em> the callback of message from the computer: do your magic there when the PC sends you some bytes</li></ul></li></ul><h2 id="toc5"><a name="Keyboard : Receiving data from host as a HID (no driver)-Links"></a> Links </h2>
Main sources (thanks to them):<br />
<ul><li>HIDKeys (as the primary source) <a class="wiki_link_ext" href="http://www.obdev.at/products/vusb/hidkeys.html" rel="nofollow">http://www.obdev.at/products/vusb/hidkeys.html</a></li><li>C64 Keyboard (for the LED status input) <a class="wiki_link_ext" href="http://symlink.dk/electro/c64key/" rel="nofollow">http://symlink.dk/electro/c64key/</a></li></ul><br />
Misc links :<br />
<ul><li>But is it both way ? <a class="wiki_link_ext" href="http://rayshobby.net/?p=7363" rel="nofollow">http://rayshobby.net/?p=7363</a></li><li>Another good one with <a class="wiki_link" href="ATtiny%202313.html">ATtiny 2313</a> but where the H*ll you put the source code?! <a class="wiki_link_ext" href="http://runawaybrainz.blogspot.co.uk/2013/08/avr-attiny-2313-v-usb-media-volume.html" rel="nofollow">http://runawaybrainz.blogspot.co.uk/2013/08/avr-attiny-2313-v-usb-media-volume.html</a></li></ul><br />
<h1 id="toc6"><a name="Links"></a> Links </h1>
Seems that there is a quite steep learning curve. For instance although my numerous trials and especially errors, it's still not working for me. Let's inspire from other smarter guys to become ourself a smarter gyu:<br />
<ul><li>Tutorial from the (very) basics <a class="wiki_link_ext" href="http://codeandlife.com/2012/01/22/avr-attiny-usb-tutorial-part-1/" rel="nofollow">http://codeandlife.com/2012/01/22/avr-attiny-usb-tutorial-part-1/</a><ul><li>Gets veeeeery interresting from part 3 ! See also that lib <a class="wiki_link_ext" href="http://codeandlife.com/2012/01/29/avr-attiny-usb-tutorial-part-3/" rel="nofollow">http://codeandlife.com/2012/01/29/avr-attiny-usb-tutorial-part-3/</a></li></ul></li><li>Some project on github <a class="wiki_link_ext" href="https://github.com/baracudaz/usb-sht" rel="nofollow">https://github.com/baracudaz/usb-sht</a></li><li>Another tutorial <a class="wiki_link_ext" href="http://www.workinprogress.ca/v-usb-tutorial-software-only-usb-for-mega-tiny/" rel="nofollow">http://www.workinprogress.ca/v-usb-tutorial-software-only-usb-for-mega-tiny/</a></li><li>A NES (or whatever) pad got USB with a ATmega 328 <a class="wiki_link_ext" href="http://www.instructables.com/id/Convert-a-NES-gamepad-to-USB-with-Arduino/" rel="nofollow">http://www.instructables.com/id/Convert-a-NES-gamepad-to-USB-with-Arduino/</a></li><li><a class="wiki_link_ext" href="http://rayshobby.net/?p=7363" rel="nofollow">http://rayshobby.net/?p=7363</a></li></ul>
    </div>
  </body>
</html>